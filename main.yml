---
- name: This will harden RHOSP services per the Red Hat OSP hardening guide
  hosts: all
  become: yes



  tasks:
     - name: Get running container ID
       command: "docker ps -q"
       register: neutron_containers

     - name: Get current config from running container to disable validation of self-signed certificates
       command: "docker cp \"{{ item }}\":/etc/nova/api-paste.ini /var/lib/config-data/puppet-generated/nova/etc/"
       with_items: "{{ neutron_containers.stdout_lines }}"
       ignore_errors: true

     - name: To disable validation of self-signed certificates for host
       lineinfile:
         path: /etc/nova/api-paste.ini
         line: "insecure=False"
         insertafter: "[filter:authtoken]"

    - name: To disable validation of self-signed certificates for containers
      lineinfile:
        path: /var/lib/config-data/puppet-generated/nova/etc/api-paste.ini
        line: "insecure=False"
        insertafter: "[filter:authtoken]"
